---
- name: Provision ROSA HCP Cluster
  block:
    - name: Create namespace ns-rosa-hcp
      shell: |
        oc create ns ns-rosa-hcp --dry-run=client -o yaml | oc apply -f -
      register: ns_result
      changed_when: "'created' in ns_result.stdout or 'configured' in ns_result.stdout"

    - name: Display namespace creation result
      debug:
        msg: "Namespace ns-rosa-hcp: {{ ns_result.stdout }}"

    - name: Check if rosa-creds-secret exists in multicluster-engine namespace
      shell: oc get secret rosa-creds-secret -n multicluster-engine
      register: mce_secret_check
      failed_when: false
      changed_when: false

    - name: Copy rosa-creds-secret from multicluster-engine to ns-rosa-hcp namespace
      shell: |
        oc get secret rosa-creds-secret -n multicluster-engine -o yaml | \
        sed 's/namespace: multicluster-engine/namespace: ns-rosa-hcp/' | \
        oc apply -f -
      register: copy_secret_result
      changed_when: "'created' in copy_secret_result.stdout or 'configured' in copy_secret_result.stdout"
      when: mce_secret_check.rc == 0

    - name: Apply AWS Identity configuration
      shell: |
        oc apply -f {{ automation_path }}/awsIdentity.yaml
      register: aws_identity_result
      changed_when: "'created' in aws_identity_result.stdout or 'configured' in aws_identity_result.stdout"

    - name: Display AWS Identity result
      debug:
        msg: "AWS Identity: {{ aws_identity_result.stdout }}"

    - name: Create OCM client secret in ns-rosa-hcp namespace
      shell: |
        oc -n ns-rosa-hcp create secret generic rosa-creds-secret \
          --from-literal=ocmClientID='{{ OCM_CLIENT_ID }}' \
          --from-literal=ocmClientSecret='{{ OCM_CLIENT_SECRET }}' \
          --from-literal=ocmApiUrl='{{ OCM_API_URL | default("https://api.stage.openshift.com") }}' \
          --dry-run=client -o yaml | oc apply -f -
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout"
      no_log: true
      when: mce_secret_check.rc != 0

    - name: Display secret creation result (without sensitive data)
      debug:
        msg: |
          Rosa credentials secret: {{ 'Copied from multicluster-engine' if mce_secret_check.rc == 0 else 'Created from OCM variables' }}

    - name: Check if ROSA HCP cluster definition file exists
      stat:
        path: "{{ rosa_hcp_cluster_file | default(automation_path + '/capi-rosahcp-test.yml') }}"
      register: cluster_file_stat

    - name: Display cluster file path
      debug:
        msg: "Using ROSA HCP cluster definition: {{ cluster_file_stat.stat.path if cluster_file_stat.stat.exists else 'File not found!' }}"

    - name: Apply ROSA HCP cluster configuration
      shell: |
        oc apply -f {{ rosa_hcp_cluster_file | default(automation_path + '/capi-rosahcp-test.yml') }}
      register: cluster_result
      changed_when: "'created' in cluster_result.stdout or 'configured' in cluster_result.stdout"
      when: cluster_file_stat.stat.exists

    - name: Display cluster creation result
      debug:
        msg: "{{ cluster_result.stdout }}"
      when: cluster_file_stat.stat.exists

    - name: Wait for ROSAControlPlane to be created
      shell: |
        oc get rosacontrolplane -n ns-rosa-hcp -o json | jq -r '.items[].metadata.name'
      register: control_plane_check
      until: control_plane_check.stdout != ""
      retries: 30
      delay: 2
      when: cluster_file_stat.stat.exists

    - name: Display provisioning status
      debug:
        msg: |
          ROSA HCP Cluster provisioning initiated successfully!

          Namespace: ns-rosa-hcp
          AWS Identity: Applied
          OCM Secret: Created
          Cluster Definition: {{ 'Applied' if cluster_file_stat.stat.exists else 'Skipped - file not found' }}

          Monitor cluster status with:
            oc get rosacontrolplane -n ns-rosa-hcp
            oc get cluster -n ns-rosa-hcp
            oc describe rosacontrolplane -n ns-rosa-hcp

  rescue:
    - name: Display error information
      debug:
        msg: "Error during ROSA HCP cluster provisioning. Check the logs above for details."

    - name: Fail with error message
      fail:
        msg: "ROSA HCP cluster provisioning failed. Review the error messages above."
