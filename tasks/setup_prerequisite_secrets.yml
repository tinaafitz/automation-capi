---
# ======================================================
# Setup Prerequisite Secrets for ROSA HCP Namespaces
# ======================================================
# This task ensures that rosa-creds-secret is available in target namespaces
# where ROSA HCP clusters will be deployed. This prevents the namespace mismatch
# issue where ROSARoleConfig controllers can't find the secret.
# ======================================================

- name: Setup prerequisite secrets for ROSA HCP provisioning
  debug:
    msg: |

      üîß Setting up prerequisite secrets for ROSA HCP provisioning

      This will:
      - Check for existing rosa-creds-secret in multicluster-engine namespace
      - Copy rosa-creds-secret to common ROSA HCP target namespaces
      - Ensure secrets are available for template-based provisioning

- name: Check if rosa-creds-secret exists in multicluster-engine namespace
  shell: oc get secret rosa-creds-secret -n multicluster-engine
  register: mce_secret_check
  failed_when: false
  changed_when: false

- name: Fail if rosa-creds-secret doesn't exist in multicluster-engine
  fail:
    msg: |
      ‚ùå PREREQUISITE MISSING ‚ùå

      The rosa-creds-secret does not exist in the multicluster-engine namespace.

      This secret is required for ROSA HCP cluster provisioning.

      ‚ö†Ô∏è  REQUIRED ACTION:
      
      Run the CAPI/CAPA configuration first:
      ansible-playbook configure_capi_environment.yaml
  when: mce_secret_check.rc != 0

- name: Get list of existing ROSA HCP namespaces
  shell: |
    oc get namespaces -l automation.acm.redhat.com/rosa-hcp=true -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo ""
  register: rosa_hcp_namespaces_labeled
  changed_when: false

- name: Get list of namespaces with ROSA resources
  shell: |
    oc get rosacontrolplane --all-namespaces --no-headers -o custom-columns=NAMESPACE:.metadata.namespace 2>/dev/null | sort | uniq || echo ""
  register: rosa_hcp_namespaces_with_resources
  changed_when: false

- name: Combine and deduplicate target namespaces
  set_fact:
    target_namespaces: >-
      {{
        (
          ['ns-rosa-hcp'] + 
          (rosa_hcp_namespaces_labeled.stdout.split() if rosa_hcp_namespaces_labeled.stdout else []) +
          (rosa_hcp_namespaces_with_resources.stdout.split() if rosa_hcp_namespaces_with_resources.stdout else [])
        ) | unique | list
      }}

- name: Display target namespaces
  debug:
    msg: |
      Target namespaces for rosa-creds-secret setup:
      {{ target_namespaces | join(', ') if target_namespaces else 'ns-rosa-hcp (default)' }}

- name: Ensure target namespaces exist
  shell: |
    oc create namespace {{ item }} --dry-run=client -o yaml | oc apply -f -
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  loop: "{{ target_namespaces }}"
  when: target_namespaces | length > 0

- name: Copy rosa-creds-secret to target namespaces
  shell: |
    # Check if secret already exists in target namespace
    if oc get secret rosa-creds-secret -n {{ item }} >/dev/null 2>&1; then
      echo "Secret already exists in {{ item }}"
      exit 0
    fi
    
    # Copy secret from multicluster-engine to target namespace
    oc get secret rosa-creds-secret -n multicluster-engine -o yaml | \
    sed 's/namespace: multicluster-engine/namespace: {{ item }}/' | \
    sed '/resourceVersion:/d' | \
    sed '/uid:/d' | \
    oc apply -f -
  register: copy_secret_result
  changed_when: "'created' in copy_secret_result.stdout or 'configured' in copy_secret_result.stdout"
  failed_when: copy_secret_result.rc != 0 and 'already exists' not in copy_secret_result.stdout
  loop: "{{ target_namespaces }}"
  when: target_namespaces | length > 0

- name: Display secret copy results
  debug:
    msg: |
      ‚úÖ Rosa-creds-secret setup completed!
      
      Secrets copied to {{ target_namespaces | length }} namespace(s):
      {% for ns in target_namespaces %}
      - {{ ns }}
      {% endfor %}
      
      Template-based ROSA HCP provisioning should now work without manual secret copying.
  when: target_namespaces | length > 0

- name: Handle case with no target namespaces
  debug:
    msg: |
      ‚ÑπÔ∏è  No target namespaces found for secret copying.
      
      Secret copying will be handled automatically when clusters are provisioned.
  when: target_namespaces | length == 0