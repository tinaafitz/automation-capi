---
# Create ROSANetwork for automated VPC and subnet provisioning

- name: Set ROSANetwork template variables
  set_fact:
    template_name: "rosa-network-config"
    template_category: "features"
    template_extension: ".yaml.j2"
    template_debug: true

- name: Resolve ROSANetwork template
  include_tasks: tasks/template_resolver.yml

- name: Create output directory for ROSANetwork
  file:
    path: "{{ output_dir }}"
    state: directory
    mode: '0755'

- name: "Create ROSANetwork for cluster {{ cluster_name }}"
  block:
    - name: Generate ROSANetwork from template
      template:
        src: "{{ resolved_template_path }}"
        dest: "{{ output_dir }}/{{ cluster_name }}-rosa-network.yaml"
        mode: '0644'
      vars:
        rosa_network_config:
          name: "{{ rosa_network_config_name | default(cluster_name + '-network') }}"
          identity_name: "{{ rosa_network_identity | default('default') }}"
          availability_zones: "{{ aws_availability_zones | default([aws_region + 'a', aws_region + 'b']) }}"
          cidr_block: "{{ vpc_cidr_block | default('10.0.0.0/16') }}"
          tags: "{{ network_tags | default({'Environment': 'test', 'TestCase': 'ACM-21174', 'CreatedBy': 'ansible-automation'}) }}"

    - name: Check if ROSANetwork already exists
      kubernetes.core.k8s_info:
        api_version: infrastructure.cluster.x-k8s.io/v1beta2
        kind: ROSANetwork
        name: "{{ rosa_network_config_name | default(cluster_name + '-network') }}"
        namespace: "{{ capi_namespace }}"
      register: existing_rosa_network
      failed_when: false

    - name: Check if existing ROSANetwork is ready
      set_fact:
        rosa_network_exists: "{{ existing_rosa_network.resources | length > 0 }}"
        rosa_network_is_ready: false
      when: existing_rosa_network.resources is defined

    - name: Check existing network ready status
      set_fact:
        rosa_network_is_ready: true
      when:
        - existing_rosa_network.resources is defined
        - existing_rosa_network.resources | length > 0
        - existing_rosa_network.resources[0].status is defined
        - existing_rosa_network.resources[0].status.conditions is defined
        - existing_rosa_network.resources[0].status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0

    - name: Display existing ROSANetwork status
      debug:
        msg: |
          ✅ ROSANetwork {{ rosa_network_config_name | default(cluster_name + '-network') }} already exists and is Ready
          Skipping creation and using existing network.
      when:
        - rosa_network_exists | default(false) | bool
        - rosa_network_is_ready | default(false) | bool

    - name: Display ROSANetwork configuration
      debug:
        msg:
          - "Creating ROSANetwork: {{ rosa_network_config_name | default(cluster_name + '-network') }}"
          - "Availability Zones: {{ aws_availability_zones | default([aws_region + 'a', aws_region + 'b']) | join(', ') }}"
          - "CIDR Block: {{ vpc_cidr_block | default('10.0.0.0/16') }}"
          - "AWS Region: {{ aws_region }}"
      when:
        - not (rosa_network_exists | default(false) | bool and rosa_network_is_ready | default(false) | bool)

    - name: Apply ROSANetwork to cluster
      kubernetes.core.k8s:
        state: present
        src: "{{ output_dir }}/{{ cluster_name }}-rosa-network.yaml"
      register: rosa_network_result
      when:
        - not (rosa_network_exists | default(false) | bool and rosa_network_is_ready | default(false) | bool)

    - name: Display ROSANetwork creation result
      debug:
        msg: "ROSANetwork creation initiated successfully"
      when:
        - rosa_network_result is defined
        - rosa_network_result is succeeded

    - name: Wait for ROSANetwork to be fully ready
      kubernetes.core.k8s_info:
        api_version: infrastructure.cluster.x-k8s.io/v1beta2
        kind: ROSANetwork
        name: "{{ rosa_network_config_name | default(cluster_name + '-network') }}"
        namespace: "{{ capi_namespace }}"
        wait: true
        wait_condition:
          type: ROSANetworkReady
          status: "True"
        wait_timeout: "{{ rosa_network_ready_timeout | default(1200) }}"
      register: network_ready_status
      when:
        - not (rosa_network_exists | default(false) | bool and rosa_network_is_ready | default(false) | bool)

    - name: Use existing ready ROSANetwork
      set_fact:
        network_ready_status:
          resources: "{{ existing_rosa_network.resources }}"
      when:
        - rosa_network_exists | default(false) | bool
        - rosa_network_is_ready | default(false) | bool

    - name: Extract network information from status
      set_fact:
        vpc_id: "{{ (network_ready_status.resources[0].status.resources | selectattr('logicalId', 'equalto', 'VPC') | map(attribute='physicalId') | list | first) | default('') }}"
        subnet_info: "{{ network_ready_status.resources[0].status.subnets | default([]) }}"
        network_resources: "{{ network_ready_status.resources[0].status.resources | default([]) }}"
        network_ready_condition: "{{ network_ready_status.resources[0].status.conditions | selectattr('type', 'equalto', 'ROSANetworkReady') | selectattr('status', 'equalto', 'True') | list | length > 0 }}"

    - name: Validate network creation success
      assert:
        that:
          - vpc_id != ""
          - subnet_info | length > 0
          - network_ready_condition == true
        fail_msg: "ROSANetwork creation failed or incomplete"
        success_msg: "ROSANetwork created successfully with VPC and subnets"

    - name: Display created network resources
      debug:
        msg:
          - "✓ ROSANetwork creation completed successfully"
          - "VPC ID: {{ vpc_id }}"
          - "Availability Zones: {{ subnet_info | length }}"
          - "Subnets per AZ: 1 public + 1 private"
          - "Total CloudFormation Resources: {{ network_resources | length }}"
          - "Network Ready: {{ network_ready_condition }}"

  rescue:
    - name: Handle ROSANetwork creation failure
      debug:
        msg: "Failed to create ROSANetwork: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Get ROSANetwork status for debugging
      kubernetes.core.k8s_info:
        api_version: infrastructure.cluster.x-k8s.io/v1beta2
        kind: ROSANetwork
        name: "{{ rosa_network_config_name | default(cluster_name + '-network') }}"
        namespace: "{{ capi_namespace }}"
      register: debug_network_status
      ignore_errors: true

    - name: Display ROSANetwork status for debugging
      debug:
        var: debug_network_status.resources[0]
      when: debug_network_status.resources | length > 0

    - name: Get ROSANetwork events for troubleshooting
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Event
        namespace: "{{ capi_namespace }}"
        field_selectors:
          - involvedObject.name={{ rosa_network_config_name | default(cluster_name + '-network') }}
      register: network_events
      ignore_errors: true

    - name: Display ROSANetwork events for troubleshooting
      debug:
        var: network_events.resources
      when: network_events.resources | length > 0

    - name: Fail the task
      fail:
        msg: "ROSANetwork creation failed for cluster {{ cluster_name }}"