---
# Create ROSARoleConfig for ACM-21162
# Automates AWS IAM role creation for ROSA HCP clusters
# Eliminates manual role setup requirements

- name: Set ROSARoleConfig creation variables
  set_fact:
    rosa_role_config_name: "{{ cluster_name }}-roles"
    template_name: "rosa-role-config"
    template_category: "features"
    template_extension: ".yaml.j2"
    template_debug: true

- name: Debug openshift_version before template
  debug:
    msg: "openshift_version = {{ openshift_version }}"

- name: Validate required variables for ROSARoleConfig
  fail:
    msg: "Required variable {{ item }} is not defined"
  when: vars[item] is not defined or vars[item] == ""
  loop:
    - cluster_name
    - aws_account_id
    - aws_region
    - capi_namespace

- name: Resolve ROSARoleConfig template
  include_tasks: tasks/template_resolver.yml

- name: Create output directory for ROSARoleConfig
  file:
    path: "{{ output_dir }}"
    state: directory
    mode: '0755'

- name: Generate ROSARoleConfig from template
  template:
    src: "{{ resolved_template_path }}"
    dest: "{{ output_dir }}/{{ rosa_role_config_name }}.yaml"
    mode: '0644'
  register: rosa_role_config_template_result

- name: Display ROSARoleConfig generation info
  debug:
    msg: |
      ROSARoleConfig generated:
      - Name: {{ rosa_role_config_name }}
      - Template Source: {{ template_source }}
      - Template Path: {{ resolved_template_path }}
      - Output File: {{ output_dir }}/{{ rosa_role_config_name }}.yaml
      - AWS Account ID: {{ aws_account_id }}
      - AWS Region: {{ aws_region }}
      - Namespace: {{ capi_namespace }}

- name: Check if ROSARoleConfig already exists
  kubernetes.core.k8s_info:
    api_version: infrastructure.cluster.x-k8s.io/v1beta2
    kind: ROSARoleConfig
    name: "{{ rosa_role_config_name }}"
    namespace: "{{ capi_namespace }}"
  register: existing_rosa_role_config
  failed_when: false

- name: Check if existing ROSARoleConfig is ready
  set_fact:
    rosa_role_config_exists: "{{ existing_rosa_role_config.resources | length > 0 }}"
    rosa_role_config_is_ready: false
  when: existing_rosa_role_config.resources is defined

- name: Check existing resource ready status
  set_fact:
    rosa_role_config_is_ready: true
  when:
    - existing_rosa_role_config.resources is defined
    - existing_rosa_role_config.resources | length > 0
    - existing_rosa_role_config.resources[0].status is defined
    - existing_rosa_role_config.resources[0].status.conditions is defined
    - existing_rosa_role_config.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0

- name: Display existing ROSARoleConfig status
  debug:
    msg: |
      âœ… ROSARoleConfig {{ rosa_role_config_name }} already exists and is Ready
      Skipping creation and using existing resource.
  when:
    - rosa_role_config_exists | default(false) | bool
    - rosa_role_config_is_ready | default(false) | bool

- name: Display ROSARoleConfig creation needed
  debug:
    msg: |
      Creating new ROSARoleConfig {{ rosa_role_config_name }} in namespace {{ capi_namespace }}
  when:
    - not (rosa_role_config_exists | default(false) | bool and rosa_role_config_is_ready | default(false) | bool)

- name: Apply ROSARoleConfig to cluster
  kubernetes.core.k8s:
    state: present
    src: "{{ output_dir }}/{{ rosa_role_config_name }}.yaml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 600
  register: rosa_role_config_apply_result
  when:
    - not (rosa_role_config_exists | default(false) | bool and rosa_role_config_is_ready | default(false) | bool)

- name: Display ROSARoleConfig apply result
  debug:
    msg: |
      ROSARoleConfig application result:
      - Status: {{ rosa_role_config_apply_result.result.status | default('Unknown') }}
      - Method: {{ rosa_role_config_apply_result.method }}
      - Name: {{ rosa_role_config_apply_result.result.metadata.name }}
      - Namespace: {{ rosa_role_config_apply_result.result.metadata.namespace }}
      - Creation Timestamp: {{ rosa_role_config_apply_result.result.metadata.creationTimestamp | default('N/A') }}
  when:
    - rosa_role_config_apply_result is defined
    - rosa_role_config_apply_result.result is defined

- name: Wait for ROSARoleConfig to be ready
  kubernetes.core.k8s_info:
    api_version: infrastructure.cluster.x-k8s.io/v1beta2
    kind: ROSARoleConfig
    name: "{{ rosa_role_config_name }}"
    namespace: "{{ capi_namespace }}"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: 900
  register: rosa_role_config_ready_result
  when:
    - not (rosa_role_config_exists | default(false) | bool and rosa_role_config_is_ready | default(false) | bool)

- name: Use existing ready ROSARoleConfig
  set_fact:
    rosa_role_config_ready_result:
      resources: "{{ existing_rosa_role_config.resources }}"
  when:
    - rosa_role_config_exists | default(false) | bool
    - rosa_role_config_is_ready | default(false) | bool

- name: Set ROSARoleConfig facts for subsequent tasks
  set_fact:
    rosa_role_config_created: true
    rosa_role_config_resource: "{{ rosa_role_config_ready_result.resources[0] }}"
    installer_role_arn: "{{ rosa_role_config_ready_result.resources[0].status.installerRoleArn | default('') }}"
    support_role_arn: "{{ rosa_role_config_ready_result.resources[0].status.supportRoleArn | default('') }}"
    worker_role_arn: "{{ rosa_role_config_ready_result.resources[0].status.workerRoleArn | default('') }}"
    oidc_provider_arn: "{{ rosa_role_config_ready_result.resources[0].status.oidcProviderArn | default('') }}"

- name: Display created AWS resources
  debug:
    msg: |
      ROSARoleConfig {{ rosa_role_config_name }} created successfully!

      AWS Resources Created:
      - Installer Role ARN: {{ installer_role_arn }}
      - Support Role ARN: {{ support_role_arn }}
      - Worker Role ARN: {{ worker_role_arn }}
      - OIDC Provider ARN: {{ oidc_provider_arn }}

      Status: {{ rosa_role_config_resource.status.phase | default('Unknown') }}