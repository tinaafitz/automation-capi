# ======================================================
# CAPI/CAPA Environment Validation Tasks
# ======================================================
# This file contains tasks to validate the MCE environment:
# 1. Check OCP login succeeded
# 2. Check CAPI/CAPA controllers are deployed
# ======================================================

# ======================================================
# STEP 1: Verify OCP Login
# ======================================================
- name: Get current OCP context
  shell: oc config current-context
  register: ocp_context_result
  failed_when: false
  changed_when: false

- name: Verify OCP context is set (from login)
  fail:
    msg: |
      ‚ùå OCP LOGIN FAILED ‚ùå

      OpenShift Hub login has not been completed successfully.

      The OCP context is not set, which means login did not succeed.

      ‚ö†Ô∏è  REQUIRED ACTION:

      1. Check your credentials in vars/user_vars.yml:
         - OCP_HUB_API_URL
         - OCP_HUB_CLUSTER_USER
         - OCP_HUB_CLUSTER_PASSWORD

      2. Verify the cluster is accessible:
         oc login {{ OCP_HUB_API_URL | default('your-cluster-api-url') }}

      3. Check network connectivity to the OpenShift Hub cluster

      4. Retry the validation after fixing login issues
  when: ocp_context_result.rc != 0 or ocp_context_result.stdout == ''

- name: OCP Login Check
  debug:
    msg: "‚úÖ Step 1/3: OCP login successful - Context: {{ ocp_context_result.stdout }}"
  when: ocp_context_result.rc == 0 and ocp_context_result.stdout != ''

# ======================================================
# STEP 2: Verify CAPI/CAPA Controllers are Deployed
# ======================================================
- name: Check for capi-controller-manager deployment
  shell: |
    oc get deploy -n multicluster-engine capi-controller-manager -o name
  register: capi_controller_manager
  failed_when: false
  changed_when: false

- name: Fail if CAPI controller not found
  fail:
    msg: |
      ‚ùå ENVIRONMENT NEEDS TO BE CONFIGURED ‚ùå

      CAPI controller (capi-controller-manager) is not deployed.

      The Cluster API controller is required for managing ROSA HCP clusters.

      ‚ö†Ô∏è  REQUIRED ACTION:

      1. Enable the CAPI feature in MCE
      2. Wait for the controller to be deployed
      3. Retry validation
  when: capi_controller_manager.rc != 0

- name: Check for capa-controller-manager deployment
  shell: |
    oc get deploy -n multicluster-engine capa-controller-manager -o name
  register: capa_controller_manager
  failed_when: false
  changed_when: false

- name: Fail if CAPA controller not found
  fail:
    msg: |
      ‚ùå ENVIRONMENT NEEDS TO BE CONFIGURED ‚ùå

      CAPA controller (capa-controller-manager) is not deployed.

      The Cluster API Provider AWS controller is required for managing ROSA HCP clusters.

      ‚ö†Ô∏è  REQUIRED ACTION:

      1. Enable the CAPA feature in MCE
      2. Wait for the controller to be deployed
      3. Retry validation
  when: capa_controller_manager.rc != 0

- name: CAPI/CAPA Controllers Check
  debug:
    msg: "‚úÖ Step 2/3: CAPI/CAPA controllers are deployed and ready"
  when: capi_controller_manager.rc == 0 and capa_controller_manager.rc == 0

# ======================================================
# STEP 3: Environment Summary
# ======================================================
- name: Environment validation summary
  debug:
    msg: |
      ‚úÖ MCE ENVIRONMENT VALIDATION SUCCESSFUL ‚úÖ

      All required components are properly configured:

      ‚úÖ OpenShift Hub Login: Connected
      ‚úÖ CAPI Controller: Deployed
      ‚úÖ CAPA Controller: Deployed

      üöÄ Environment is ready for ROSA HCP cluster provisioning!

      Next steps:
      1. Configure AWS credentials (if not done)
      2. Create ROSA HCP cluster definitions
      3. Deploy clusters using the automation
  when: 
    - ocp_context_result.rc == 0 
    - ocp_context_result.stdout != ''
    - capi_controller_manager.rc == 0 
    - capa_controller_manager.rc == 0